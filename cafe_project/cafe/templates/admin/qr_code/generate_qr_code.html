{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    .modal-content {
        position: relative;
        background: white;
        margin: 15% auto;
        padding: 20px;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }

    .close {
        position: absolute;
        right: 10px;
        top: 10px;
        font-size: 24px;
        cursor: pointer;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
    }

    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .btn-generate {
        background: var(--primary);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .qr-preview {
        text-align: center;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="module">
    <h2>QR Code Management</h2>
    <button id="openModal" class="btn-generate">Generate QR Code</button>

    <!-- QR Code Generation Modal -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Generate QR Code</h3>
            <form id="qrForm">
                {% csrf_token %}
                <div class="form-group">
                    <label for="tableNumber">Table Number:</label>
                    <input type="number" id="tableNumber" name="table_number" required min="1">
                </div>
                <button type="submit" class="btn-generate">Generate</button>
            </form>
            <div class="qr-preview" id="qrPreview"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('qrModal');
    const openBtn = document.getElementById('openModal');
    const closeBtn = document.querySelector('.close');
    const form = document.getElementById('qrForm');
    const preview = document.getElementById('qrPreview');

    // Open modal
    openBtn.onclick = function() {
        modal.style.display = 'block';
        preview.innerHTML = '';
    }

    // Close modal
    closeBtn.onclick = function() {
        modal.style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }

    // Handle form submission
    form.onsubmit = async function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/admin/generate-qr-code/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                }
            });

            const data = await response.json();
            
            if (data.success) {
                preview.innerHTML = `
                    <h4>QR Code for Table ${data.table_number}</h4>
                    <img src="${data.qr_code_url}" alt="QR Code" style="max-width: 200px;">
                    <br>
                    <a href="${data.qr_code_url}" download class="btn-generate" style="display: inline-block; margin-top: 10px;">
                        Download QR Code
                    </a>
                `;
            } else {
                alert('Error generating QR code: ' + data.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to generate QR code. Please try again.');
        }
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}