{% extends "admin_panel/base_admin.html" %}
{% block content %}

<!-- CSRF token setup -->
<meta name="csrf-token" content="{{ csrf_token }}">

<style>
  .qr-btn {
    background-color: #008080;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
  }
  .qr-btn:hover {
    background-color: #006666;
  }

  .qr-modal {
    display: none;
    position: fixed;
    top: 0; 
    left: 0;
    width: 100%; 
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }

  .qr-modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 300px;
    position: relative;
  }

  .qr-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
  }

  .qr-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: flex-start;
    margin-top: 20px;
  }

  .qr-card {
    background: white;
    width: 368px;
    height: 300px;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
    position: relative;
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    cursor: pointer;
  }
  .qr-card:hover {
    transform: translateY(-4px);
    box-shadow: 2px 6px 12px rgba(0, 0, 0, 0.15);
  }

  .qr-remove {
    background-color: red;
    color: white;
    padding: 6px 9px;
    font-size: 14px;
    border-radius: 50%;
    position: absolute;
    top: 5px;
    right: 5px;
    cursor: pointer;
    border: none;
  }

  .qr-remove:hover {
    background-color: darkred;
  }
</style>

<div class="qr-page-container">
  <button id="openModal" class="qr-btn">+ Generate QR Code</button>

  <div id="qrModal" class="qr-modal">
    <div class="qr-modal-content">
      <span class="qr-close">&times;</span>
      <h2>Generate QR Code</h2>
      <form id="qrForm">
        {% csrf_token %}
        <select id="tableSelect" required>
          <option value="">Select a Table</option>
          {% for table in tables %}
            <option value="{{ table.number }}">Table {{ table.number }}</option>
          {% endfor %}
        </select>
        <br><br>
        <button type="submit" class="qr-btn">Generate</button>
      </form>
    </div>
  </div>

  <div class="qr-grid" id="gridContainer">
    {% for table in tables %}
      <div class="qr-card" id="table-{{ table.number }}">
        <button class="qr-remove" onclick="removeQRCode({{ table.number }})">X</button>
        <div class="qr-info">
          <h3>Table {{ table.number }}</h3>
          <p class="qr-status {% if table.is_active %}active{% else %}inactive{% endif %}">
            Status: {% if table.is_active %} ✅ Active {% else %} ❌ Inactive {% endif %}
          </p>
        </div>
        {% if table.qr_code and table.qr_code.qr_code %}
          <div class="qr-img-container">
            <img src="{{ table.qr_code }}" alt="QR Code">
            <a href="{{ table.qr_code.qr_code.url }}" download="table_{{ table.number }}.png" class="qr-download">
              ⬇ Download
            </a>
          </div>
        {% else %}
          <p>No QR Code Generated</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const csrfToken = document.querySelector("meta[name='csrf-token']").getAttribute("content");

  const modal = document.getElementById("qrModal");
  const openBtn = document.getElementById("openModal");
  const closeBtn = document.querySelector(".qr-close");
  const form = document.getElementById("qrForm");

  openBtn.addEventListener("click", function() {
    modal.style.display = "flex";
    document.body.classList.add("modal-open");
  });

  closeBtn.addEventListener("click", () => {
    modal.style.display = "none";
    document.body.classList.remove("modal-open");
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const tableNumber = document.getElementById("tableSelect").value;

    if (!tableNumber) {
      alert("Please select a table.");
      return;
    }

    try {
      const response = await fetch("/admin-panel/generate-qr-code/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({ table_number: tableNumber })
      });

      const data = await response.json();
      if (data.success) {
        alert(`QR Code for Table ${data.table_number} generated successfully!`);
        location.reload();
      } else {
        alert("Error: " + data.error);
      }
    } catch (error) {
      console.error("Request failed:", error);
      alert("Request failed. Please try again.");
    }
  });
});
</script>

{% endblock %}
